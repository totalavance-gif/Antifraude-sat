<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antifraude SAT Â· Unificado</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4f6f8}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;border-radius:14px;padding:20px;margin-bottom:20px;
box-shadow:0 6px 18px rgba(0,0,0,.08)}
.hidden{display:none}
input,button{width:100%;padding:10px;margin-top:6px}
button{background:#2563eb;color:#fff;border:none;border-radius:10px}
.red{background:#dc2626}
.green{background:#16a34a}
.bad{border-left:6px solid #dc2626}
.warn{border-left:6px solid #f59e0b}
.ok{border-left:6px solid #16a34a}
small{color:#64748b}
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="card">
<h2>ğŸ” Acceso</h2>
<input id="user" placeholder="Usuario">
<input id="pass" type="password" placeholder="ContraseÃ±a">
<button onclick="loginUser()">Entrar como usuario</button>
<hr>
<input id="adminPass" type="password" placeholder="ContraseÃ±a admin">
<button onclick="loginAdmin()" class="red">Entrar como admin</button>
</div>

<!-- USUARIO -->
<div id="userPanel" class="hidden">

<h2>ğŸ‘¤ Panel Usuario</h2>
<p>Usuario: <b id="userName"></b></p>

<button onclick="logout()" class="red">Cerrar sesiÃ³n</button>

<div class="card">
  <h3>ğŸ“„ Analizar PDF SAT</h3>
  <input type="file" accept="application/pdf" id="pdfInput">
</div>

<div id="result"></div>

</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden">

<h2>ğŸ›¡ï¸ Panel Administrador</h2>

<button onclick="logout()" class="red">Cerrar sesiÃ³n</button>

<div class="card">
<h3>â• Crear usuario</h3>
<input id="newUser" placeholder="Usuario">
<input id="newPass" placeholder="ContraseÃ±a">
<button onclick="createUser()" class="green">Crear</button>
</div>

<div class="card">
<h3>ğŸ‘¥ Usuarios</h3>
<ul id="usersList"></ul>
</div>

<div class="card">
<h3>ğŸ“Š Historial global</h3>
<ul id="history"></ul>
</div>

</div>

</div>

<script>
/* ================= CONFIG ================= */
const ADMIN_PASSWORD="satadmin123";
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ================= SESSION ================= */
function logout(){
  localStorage.removeItem("session");
  location.reload();
}

/* ================= USERS ================= */
function getUsers(){
  return JSON.parse(localStorage.getItem("users")||"[]");
}
function saveUsers(u){
  localStorage.setItem("users",JSON.stringify(u));
}

/* ================= LOGIN ================= */
function loginUser(){
  const u=user.value.trim(), p=pass.value.trim();
  const ok=getUsers().find(x=>x.username===u && x.password===p);
  if(!ok) return alert("Credenciales incorrectas");
  localStorage.setItem("session",JSON.stringify({role:"user",user:u}));
  init();
}

function loginAdmin(){
  if(adminPass.value!==ADMIN_PASSWORD)
    return alert("ContraseÃ±a admin incorrecta");
  localStorage.setItem("session",JSON.stringify({role:"admin"}));
  init();
}

/* ================= INIT ================= */
function init(){
  const s=JSON.parse(localStorage.getItem("session")||"null");
  if(!s) return;
  loginBox.classList.add("hidden");

  if(s.role==="user"){
    userPanel.classList.remove("hidden");
    userName.textContent=s.user;
  }
  if(s.role==="admin"){
    adminPanel.classList.remove("hidden");
    loadUsers();
    loadHistory();
  }
}
init();

/* ================= ADMIN ================= */
function createUser(){
  const u=newUser.value.trim(), p=newPass.value.trim();
  if(!u||!p) return alert("Datos incompletos");
  const users=getUsers();
  if(users.find(x=>x.username===u)) return alert("Usuario existe");
  users.push({username:u,password:p});
  saveUsers(users);
  newUser.value="";newPass.value="";
  loadUsers();
}

function deleteUser(i){
  if(!confirm("Â¿Eliminar usuario?")) return;
  const u=getUsers();
  u.splice(i,1);
  saveUsers(u);
  loadUsers();
}

function loadUsers(){
  usersList.innerHTML=getUsers().map((u,i)=>`
    <li>${u.username}
      <button onclick="deleteUser(${i})" class="red">Eliminar</button>
    </li>`).join("");
}

/* ================= ANALYSIS ================= */
document.getElementById("pdfInput").addEventListener("change", analyzePDF);

async function analyzePDF(e){
  const file=e.target.files[0];
  if(!file) return;

  const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
  let text="",score=0,features=[];

  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const tc=await page.getTextContent();
    text+=tc.items.map(t=>t.str).join(" ");
  }

  if(/Asalariado1/.test(text)){score+=9;features.push("Error Asalariado1");}
  if(!/idCIF:\s*\d+/.test(text)){score+=3;features.push("idCIF ausente");}

  let level="ok",res="ğŸŸ¢ ORIGINAL";
  if(score>=7){level="bad";res="ğŸ”´ POSIBLE CLON";}
  else if(score>=3){level="warn";res="ğŸŸ¡ SOSPECHOSO";}

  saveAnalysis(score,res,features);

  result.innerHTML=`
  <div class="card ${level}">
    <h3>${res}</h3>
    <p>Score: ${score}</p>
    <ul>${features.map(f=>`<li>${f}</li>`).join("")}</ul>
  </div>`;
}

/* ================= STORAGE ================= */
function saveAnalysis(score,result,features){
  const s=JSON.parse(localStorage.getItem("session"));
  const h=JSON.parse(localStorage.getItem("analysis")||"[]");
  h.push({
    user:s.user||"admin",
    score,result,features,
    date:new Date().toLocaleString()
  });
  localStorage.setItem("analysis",JSON.stringify(h));
}

function loadHistory(){
  const h=JSON.parse(localStorage.getItem("analysis")||"[]");
  history.innerHTML=h.slice().reverse().map(x=>`
    <li><b>${x.user}</b> Â· ${x.date}<br>${x.result} (Score ${x.score})</li>
  `).join("");
}
</script>
</body>
</html>
